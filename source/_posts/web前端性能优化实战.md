---
title: web前端性能优化实战
date: 2018-01-29 12:30:21
tags: [前端性能优化]
---

#### 前言

记得刚接手这个项目时，PM 直接从网上找了一个 bootstrap 模板，然后找了一家外包公司，以一个页面大概 500 软妹币的价格定制了现在项目的 html 和 css 源码。当然，这都是我进公司之前的事了，当时公司没有前端，只有三个 java 后台。当时进公司的第一天，我的内心是崩溃的，整个项目前后端不分离，后端模板和路由，前端只负责 angularjs 做数据绑定，至今我还记得那个兼职的架构师在制定完架构之后看到我之后惊呼道：“我们还有前端啊！”。对，在原本的规划中，他们是不需要前端的，但是后台不 angularjs，这又和架构师的设想不太一样。第二天，我开始尝试着跑项目，我又一次震惊了，整个项目打开登录页面速度很快，但是进入主页需要将近 5s！然后我试着去看了时间主要花费在哪里，我看到首页加载了 80+js 文件，全都是各种 js 插件和 bootstrap 组件，而且加载顺序是错乱的。再仔细看业务相关的 js 文件，完全没有加载顺序相关的控制逻辑，到处都是全局变量，jquery 和 angular 混杂，angularjs 确实只负责了做数据绑定，主要交互竟然全都交给了 jquery 做。于是，我决定我的第一个任务就是来改造这个加载速度。

#### 性能瓶颈分析

经过两天的仔细研究，我仔细百度了每一个 js 文件的作用和用法，因为原模板是老外写的，用到了很多国内不是很常见的 js 插件，很多插件的版本也很老，原模板是纯 jquery 的，现在又混入了 angularjs，所以感觉整个完全没有设计，非常混乱。综合考虑，我采用了如下的做法：

* 1> 删除目前业务不太可能用到的插件，特别是生僻的插件
* 2> 对重要插件进行版本升级
* 3> 使用 gulp 对多处使用的插件打包压缩

最终，我得到了一个体积接近 3M 的包，公有 css 也有将近 200kb。首页加载速度优化到了 800ms。
{% img https://blog-1255356076.cos.ap-shanghai.myqcloud.com/TIM%E6%88%AA%E5%9B%BE20180126164340.png %}
虽然效果很明显，但是这还远远不够，800ms 对于系统来说体验太差了。但是 PM 和 leader 显然丝毫不在乎这种事，毕竟对于之前的 5s，这显然已经好太多了。但是作为一个前端工程师，我是非常不满足的，我觉得一个优秀的产品加载速度应该不能超过 300ms。从上面这张图可以看出，现在时间花费主要有这几个方面：

* 1> 文件过多可以看出每个文件的加载时长都不是很长，但是首页需要加载将近 12 个文件，按照 chrome 一个域名下最多同时开启 6 个 http 通道的话，也需要至少两轮，所以有很多时间是浪费在等待上面的。（实际测试中发现同时并没有开启那么多 http 通道，可能是我观测的方式不对。）
* 2> 请求过多首页每个类目单独的接口，后台为了追求解耦合，每个请求单独的接口，也没有提供每个页面初始化的单独接口，所以造成了 http 请求通道的占用和阻塞。与后台协商未果，后台表示不愿意修改和增加接口。卒。
* 3> 接口性能后台接口性能差，每个接口基本都在 100ms 以上，这也直接影响了整个系统的性能。

网络这块我已经无能为力了，之所以 js 文件大是因为数量多，数量多是因为业务中大量用到了 DataTable，DataTable 及其扩展插件就有十几个，大小将近 1M。实际业务中，有涉及到小数计算部分，虽然是简单的四则运算，但这是前端 js 最不擅长的啊，因为之前一直也没做到过这块（之前都是后台提供接口，现项目后台不愿意提供，觉得麻烦），后来在技术选型时做的调研不够，引用了 math.js，这个库压缩之后仍有 500kb，后来发现时因为使用过多，已经来不及修改了。接下来是性能测试：

{% img https://blog-1255356076.cos.ap-shanghai.myqcloud.com/TIM%E6%88%AA%E5%9B%BE20180126173156.png %}

根据上图可以看出，chrome 确实是可以同时开启 6 个 http 通道下载的，但是不总是这样，这可能和 cpu 以及内存都有关系，属于浏览器内核的策略，不是代码能够控制的。所以这部分被阻塞的 http 请求浪费的时间无能为力了。这些接口请求完成后引起的页面的 repaint 也是无法挽回的。主线程上的执行情况是错综复杂的，本人能力有限，也只能解读一部分。首先是接收到了 html 文件之后开始解析（蓝色部分），然后遇到了三个 css 文件，开始下载并解析 css 文件（紫色部分），然后遇到了 js 文件，开始下载 js 文件（算是浅蓝色吧），下载完第一个 js 之后开始执行（黄色部分），这个时候主进程是被阻塞的不能继续解析 HTML 和 css，因为第一个 js 文件很大，所以执行花费了很久（368ms），然后继续解析 html 和 css，解析这段 html 也花费了很久（600+ms），中间夹杂着各种 jquery 的插件在 DOMContentLoaded 之后的各种初始化然后引起的页面结构和样式的变化和 repaint。这里我不是很理解为什么解析 html 会花费了这么长时间，初步猜测是因为后台模板替换的时候导致生成的 html 文件结构有些错乱，后台模板文件我也不懂，后台里面他们也是第一次用。。。至于这部分 jquery 插件的初始化，也是花费了相当多的时间，加上接口返回数据慢，angularjs 拿到数据之后又进行绑定，而且整个项目并没有完全交给 angular 接管，js 文件的执行顺序基本不可控，最终导致了这个加载和渲染过程的不可控。到这里为止，我感觉自己已经无能为力了。我也向 leader 提出了重构，但是得到的答案是没有时间和精力。这里我对 freemarker 这款后端模板不是很了解，但是就我看来，这应该也是一款功能很强大的模板，它是完全有能力在后端进行数据输出的，但是在这个项目中，它仅仅用来做某些按钮的显示和移除（权限）。
